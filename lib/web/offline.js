/*
 * @file web/offline.ts
 * Relution SDK
 *
 * Created by Thomas Beckmann on 30.06.2016
 * Copyright 2016 M-Way Solutions GmbH
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/**
 * @module web
 */
/** */
"use strict";
var Q = require('q');
var cipher = require('../core/cipher');
/**
 * localStorage of browser or via require node-localstorage.
 *
 * @internal Not public API, exported for testing purposes only!
 */
function localStorage() {
    return global['localStorage'] ||
        process && !process['browser'] && (global['localStorage'] =
            new (require('node-localstorage').LocalStorage)('localStorage')); // required version
}
exports.localStorage = localStorage;
/**
 * computes key of login response data for some server.
 *
 * @param serverOptions providing server URL so that keys do not collide.
 * @return {string} key suitable for local storage.
 */
function computeLocalStorageKey(serverOptions) {
    var uniqueModuleName = module.filename || __filename;
    return uniqueModuleName + '-' + serverOptions.serverUrl;
}
/**
 * deletes stored login response of some server.
 *
 * @param credentials allowing to differentiate when multiple logins are used simultaneously, may
 *  be null to forget just anything.
 * @param serverOptions identifying the server.
 * @return {Promise<void>} indicating success or failure.
 *
 * @internal Not part of public API, for library use only.
 */
function clearOfflineLogin(credentials, serverOptions) {
    // simultaneous logins using different credentials is not realized so far,
    // so that the credentials parameter is irrelevant, but provided for the
    // sake of completeness...
    try {
        localStorage().removeItem(computeLocalStorageKey(serverOptions));
        return Q.resolve(undefined);
    }
    catch (error) {
        return Q.reject(error);
    }
}
exports.clearOfflineLogin = clearOfflineLogin;
/**
 * writes response data to persistent storage for offline login purposes.
 *
 * @param credentials required for encryption.
 * @param serverOptions identifying the server.
 * @param loginResponse permitted to durable storage.
 * @return {Promise<http.LoginResponse>} indicating success or failure.
 *
 * @internal Not part of public API, for library use only.
 */
function storeOfflineLogin(credentials, serverOptions, loginResponse) {
    return cipher.encryptJson(credentials['password'], loginResponse).then(function (value) {
        localStorage().setItem(computeLocalStorageKey(serverOptions), JSON.stringify(value));
        return loginResponse;
    });
}
exports.storeOfflineLogin = storeOfflineLogin;
/**
 * reads response data from persistent storage.
 *
 * When there is no data in persitent store, the operation does NOT fail. In this case the
 * resulting promise resolves to nil instead.
 *
 * @param credentials required for decryption.
 * @param serverOptions identifying the server.
 * @return {Promise<http.LoginResponse>} read from store, resolves to nil when there is no data,
 *  gets rejected when decryption fails.
 *
 * @internal Not part of public API, for library use only.
 */
function fetchOfflineLogin(credentials, serverOptions) {
    try {
        var value = localStorage().getItem(computeLocalStorageKey(serverOptions));
        if (!value) {
            return Q.resolve(undefined);
        }
        return cipher.decryptJson(credentials['password'], JSON.parse(value));
    }
    catch (error) {
        return Q.reject(error);
    }
}
exports.fetchOfflineLogin = fetchOfflineLogin;
exports.emptyInternal = function () {
    return 'hello';
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib2ZmbGluZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy93ZWIvb2ZmbGluZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7Ozs7Ozs7Ozs7Ozs7O0dBa0JHO0FBQ0g7O0dBRUc7QUFDSCxNQUFNOztBQUVOLElBQVksQ0FBQyxXQUFNLEdBQUcsQ0FBQyxDQUFBO0FBRXZCLElBQVksTUFBTSxXQUFNLGdCQUFnQixDQUFDLENBQUE7QUFJekM7Ozs7R0FJRztBQUNIO0lBQ0UsTUFBTSxDQUFDLE1BQU0sQ0FBQyxjQUFjLENBQUM7UUFDM0IsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLGNBQWMsQ0FBQztZQUN2RCxJQUFJLENBQUMsT0FBTyxDQUFDLG1CQUFtQixDQUFDLENBQUMsWUFBWSxDQUFDLENBQUMsY0FBYyxDQUFDLENBQUMsQ0FBQyxDQUFDLG1CQUFtQjtBQUMzRixDQUFDO0FBSmUsb0JBQVksZUFJM0IsQ0FBQTtBQUVEOzs7OztHQUtHO0FBQ0gsZ0NBQWdDLGFBQW9DO0lBQ2xFLElBQU0sZ0JBQWdCLEdBQUcsTUFBTSxDQUFDLFFBQVEsSUFBSSxVQUFVLENBQUM7SUFDdkQsTUFBTSxDQUFDLGdCQUFnQixHQUFHLEdBQUcsR0FBRyxhQUFhLENBQUMsU0FBUyxDQUFDO0FBQzFELENBQUM7QUFFRDs7Ozs7Ozs7O0dBU0c7QUFDSCwyQkFBa0MsV0FBNkIsRUFDN0IsYUFBb0M7SUFDcEUsMEVBQTBFO0lBQzFFLHdFQUF3RTtJQUN4RSwwQkFBMEI7SUFDMUIsSUFBSSxDQUFDO1FBQ0gsWUFBWSxFQUFFLENBQUMsVUFBVSxDQUFDLHNCQUFzQixDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUM7UUFDakUsTUFBTSxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQU8sU0FBUyxDQUFDLENBQUM7SUFDcEMsQ0FBRTtJQUFBLEtBQUssQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7UUFDZixNQUFNLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBTyxLQUFLLENBQUMsQ0FBQztJQUMvQixDQUFDO0FBQ0gsQ0FBQztBQVhlLHlCQUFpQixvQkFXaEMsQ0FBQTtBQUVEOzs7Ozs7Ozs7R0FTRztBQUNILDJCQUFrQyxXQUE2QixFQUM3QixhQUFvQyxFQUNwQyxhQUFpQztJQUVqRSxNQUFNLENBQUMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxXQUFXLENBQUMsVUFBVSxDQUFDLEVBQUUsYUFBYSxDQUFDLENBQUMsSUFBSSxDQUFDLFVBQUMsS0FBSztRQUMzRSxZQUFZLEVBQUUsQ0FBQyxPQUFPLENBQUMsc0JBQXNCLENBQUMsYUFBYSxDQUFDLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO1FBQ3JGLE1BQU0sQ0FBQyxhQUFhLENBQUM7SUFDdkIsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDO0FBUmUseUJBQWlCLG9CQVFoQyxDQUFBO0FBRUQ7Ozs7Ozs7Ozs7OztHQVlHO0FBQ0gsMkJBQWtDLFdBQTZCLEVBQzdCLGFBQW9DO0lBRXBFLElBQUksQ0FBQztRQUNILElBQUksS0FBSyxHQUFHLFlBQVksRUFBRSxDQUFDLE9BQU8sQ0FBQyxzQkFBc0IsQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDO1FBQzFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztZQUNYLE1BQU0sQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFxQixTQUFTLENBQUMsQ0FBQztRQUNsRCxDQUFDO1FBQ0QsTUFBTSxDQUFDLE1BQU0sQ0FBQyxXQUFXLENBQXFCLFdBQVcsQ0FBQyxVQUFVLENBQUMsRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7SUFDNUYsQ0FBRTtJQUFBLEtBQUssQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7UUFDZixNQUFNLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBcUIsS0FBSyxDQUFDLENBQUM7SUFDN0MsQ0FBQztBQUNILENBQUM7QUFaZSx5QkFBaUIsb0JBWWhDLENBQUE7QUFFWSxxQkFBYSxHQUFHO0lBQzNCLE1BQU0sQ0FBQyxPQUFPLENBQUM7QUFDakIsQ0FBQyxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIEBmaWxlIHdlYi9vZmZsaW5lLnRzXG4gKiBSZWx1dGlvbiBTREtcbiAqXG4gKiBDcmVhdGVkIGJ5IFRob21hcyBCZWNrbWFubiBvbiAzMC4wNi4yMDE2XG4gKiBDb3B5cmlnaHQgMjAxNiBNLVdheSBTb2x1dGlvbnMgR21iSFxuICpcbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG4gKiB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4gKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbiAqXG4gKiBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG4gKiBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG4gKiBXSVRIT1VUIFdBUlJBTlRJRVMgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZWl0aGVyIGV4cHJlc3Mgb3IgaW1wbGllZC5cbiAqIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbiAqIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG4vKipcbiAqIEBtb2R1bGUgd2ViXG4gKi9cbi8qKiAqL1xuXG5pbXBvcnQgKiBhcyBRIGZyb20gJ3EnO1xuaW1wb3J0ICogYXMgYXV0aCBmcm9tICcuLi9zZWN1cml0eS9hdXRoJztcbmltcG9ydCAqIGFzIGNpcGhlciBmcm9tICcuLi9jb3JlL2NpcGhlcic7XG5pbXBvcnQgKiBhcyBodHRwIGZyb20gJy4vaHR0cCc7XG5pbXBvcnQgKiBhcyBpbml0IGZyb20gJy4uL2NvcmUvaW5pdCc7XG5cbi8qKlxuICogbG9jYWxTdG9yYWdlIG9mIGJyb3dzZXIgb3IgdmlhIHJlcXVpcmUgbm9kZS1sb2NhbHN0b3JhZ2UuXG4gKlxuICogQGludGVybmFsIE5vdCBwdWJsaWMgQVBJLCBleHBvcnRlZCBmb3IgdGVzdGluZyBwdXJwb3NlcyBvbmx5IVxuICovXG5leHBvcnQgZnVuY3Rpb24gbG9jYWxTdG9yYWdlKCkge1xuICByZXR1cm4gZ2xvYmFsWydsb2NhbFN0b3JhZ2UnXSB8fFxuICAgIHByb2Nlc3MgJiYgIXByb2Nlc3NbJ2Jyb3dzZXInXSAmJiAoZ2xvYmFsWydsb2NhbFN0b3JhZ2UnXSA9XG4gICAgICBuZXcgKHJlcXVpcmUoJ25vZGUtbG9jYWxzdG9yYWdlJykuTG9jYWxTdG9yYWdlKSgnbG9jYWxTdG9yYWdlJykpOyAvLyByZXF1aXJlZCB2ZXJzaW9uXG59XG5cbi8qKlxuICogY29tcHV0ZXMga2V5IG9mIGxvZ2luIHJlc3BvbnNlIGRhdGEgZm9yIHNvbWUgc2VydmVyLlxuICpcbiAqIEBwYXJhbSBzZXJ2ZXJPcHRpb25zIHByb3ZpZGluZyBzZXJ2ZXIgVVJMIHNvIHRoYXQga2V5cyBkbyBub3QgY29sbGlkZS5cbiAqIEByZXR1cm4ge3N0cmluZ30ga2V5IHN1aXRhYmxlIGZvciBsb2NhbCBzdG9yYWdlLlxuICovXG5mdW5jdGlvbiBjb21wdXRlTG9jYWxTdG9yYWdlS2V5KHNlcnZlck9wdGlvbnM6IGluaXQuU2VydmVyVXJsT3B0aW9ucykge1xuICBjb25zdCB1bmlxdWVNb2R1bGVOYW1lID0gbW9kdWxlLmZpbGVuYW1lIHx8IF9fZmlsZW5hbWU7XG4gIHJldHVybiB1bmlxdWVNb2R1bGVOYW1lICsgJy0nICsgc2VydmVyT3B0aW9ucy5zZXJ2ZXJVcmw7XG59XG5cbi8qKlxuICogZGVsZXRlcyBzdG9yZWQgbG9naW4gcmVzcG9uc2Ugb2Ygc29tZSBzZXJ2ZXIuXG4gKlxuICogQHBhcmFtIGNyZWRlbnRpYWxzIGFsbG93aW5nIHRvIGRpZmZlcmVudGlhdGUgd2hlbiBtdWx0aXBsZSBsb2dpbnMgYXJlIHVzZWQgc2ltdWx0YW5lb3VzbHksIG1heVxuICogIGJlIG51bGwgdG8gZm9yZ2V0IGp1c3QgYW55dGhpbmcuXG4gKiBAcGFyYW0gc2VydmVyT3B0aW9ucyBpZGVudGlmeWluZyB0aGUgc2VydmVyLlxuICogQHJldHVybiB7UHJvbWlzZTx2b2lkPn0gaW5kaWNhdGluZyBzdWNjZXNzIG9yIGZhaWx1cmUuXG4gKlxuICogQGludGVybmFsIE5vdCBwYXJ0IG9mIHB1YmxpYyBBUEksIGZvciBsaWJyYXJ5IHVzZSBvbmx5LlxuICovXG5leHBvcnQgZnVuY3Rpb24gY2xlYXJPZmZsaW5lTG9naW4oY3JlZGVudGlhbHM6IGF1dGguQ3JlZGVudGlhbHMsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VydmVyT3B0aW9uczogaW5pdC5TZXJ2ZXJVcmxPcHRpb25zKTogUS5Qcm9taXNlPHZvaWQ+IHtcbiAgLy8gc2ltdWx0YW5lb3VzIGxvZ2lucyB1c2luZyBkaWZmZXJlbnQgY3JlZGVudGlhbHMgaXMgbm90IHJlYWxpemVkIHNvIGZhcixcbiAgLy8gc28gdGhhdCB0aGUgY3JlZGVudGlhbHMgcGFyYW1ldGVyIGlzIGlycmVsZXZhbnQsIGJ1dCBwcm92aWRlZCBmb3IgdGhlXG4gIC8vIHNha2Ugb2YgY29tcGxldGVuZXNzLi4uXG4gIHRyeSB7XG4gICAgbG9jYWxTdG9yYWdlKCkucmVtb3ZlSXRlbShjb21wdXRlTG9jYWxTdG9yYWdlS2V5KHNlcnZlck9wdGlvbnMpKTtcbiAgICByZXR1cm4gUS5yZXNvbHZlPHZvaWQ+KHVuZGVmaW5lZCk7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgcmV0dXJuIFEucmVqZWN0PHZvaWQ+KGVycm9yKTtcbiAgfVxufVxuXG4vKipcbiAqIHdyaXRlcyByZXNwb25zZSBkYXRhIHRvIHBlcnNpc3RlbnQgc3RvcmFnZSBmb3Igb2ZmbGluZSBsb2dpbiBwdXJwb3Nlcy5cbiAqXG4gKiBAcGFyYW0gY3JlZGVudGlhbHMgcmVxdWlyZWQgZm9yIGVuY3J5cHRpb24uXG4gKiBAcGFyYW0gc2VydmVyT3B0aW9ucyBpZGVudGlmeWluZyB0aGUgc2VydmVyLlxuICogQHBhcmFtIGxvZ2luUmVzcG9uc2UgcGVybWl0dGVkIHRvIGR1cmFibGUgc3RvcmFnZS5cbiAqIEByZXR1cm4ge1Byb21pc2U8aHR0cC5Mb2dpblJlc3BvbnNlPn0gaW5kaWNhdGluZyBzdWNjZXNzIG9yIGZhaWx1cmUuXG4gKlxuICogQGludGVybmFsIE5vdCBwYXJ0IG9mIHB1YmxpYyBBUEksIGZvciBsaWJyYXJ5IHVzZSBvbmx5LlxuICovXG5leHBvcnQgZnVuY3Rpb24gc3RvcmVPZmZsaW5lTG9naW4oY3JlZGVudGlhbHM6IGF1dGguQ3JlZGVudGlhbHMsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VydmVyT3B0aW9uczogaW5pdC5TZXJ2ZXJVcmxPcHRpb25zLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2luUmVzcG9uc2U6IGh0dHAuTG9naW5SZXNwb25zZSk6XG5RLlByb21pc2U8aHR0cC5Mb2dpblJlc3BvbnNlPiB7XG4gIHJldHVybiBjaXBoZXIuZW5jcnlwdEpzb24oY3JlZGVudGlhbHNbJ3Bhc3N3b3JkJ10sIGxvZ2luUmVzcG9uc2UpLnRoZW4oKHZhbHVlKSA9PiB7XG4gICAgbG9jYWxTdG9yYWdlKCkuc2V0SXRlbShjb21wdXRlTG9jYWxTdG9yYWdlS2V5KHNlcnZlck9wdGlvbnMpLCBKU09OLnN0cmluZ2lmeSh2YWx1ZSkpO1xuICAgIHJldHVybiBsb2dpblJlc3BvbnNlO1xuICB9KTtcbn1cblxuLyoqXG4gKiByZWFkcyByZXNwb25zZSBkYXRhIGZyb20gcGVyc2lzdGVudCBzdG9yYWdlLlxuICpcbiAqIFdoZW4gdGhlcmUgaXMgbm8gZGF0YSBpbiBwZXJzaXRlbnQgc3RvcmUsIHRoZSBvcGVyYXRpb24gZG9lcyBOT1QgZmFpbC4gSW4gdGhpcyBjYXNlIHRoZVxuICogcmVzdWx0aW5nIHByb21pc2UgcmVzb2x2ZXMgdG8gbmlsIGluc3RlYWQuXG4gKlxuICogQHBhcmFtIGNyZWRlbnRpYWxzIHJlcXVpcmVkIGZvciBkZWNyeXB0aW9uLlxuICogQHBhcmFtIHNlcnZlck9wdGlvbnMgaWRlbnRpZnlpbmcgdGhlIHNlcnZlci5cbiAqIEByZXR1cm4ge1Byb21pc2U8aHR0cC5Mb2dpblJlc3BvbnNlPn0gcmVhZCBmcm9tIHN0b3JlLCByZXNvbHZlcyB0byBuaWwgd2hlbiB0aGVyZSBpcyBubyBkYXRhLFxuICogIGdldHMgcmVqZWN0ZWQgd2hlbiBkZWNyeXB0aW9uIGZhaWxzLlxuICpcbiAqIEBpbnRlcm5hbCBOb3QgcGFydCBvZiBwdWJsaWMgQVBJLCBmb3IgbGlicmFyeSB1c2Ugb25seS5cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGZldGNoT2ZmbGluZUxvZ2luKGNyZWRlbnRpYWxzOiBhdXRoLkNyZWRlbnRpYWxzLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlcnZlck9wdGlvbnM6IGluaXQuU2VydmVyVXJsT3B0aW9ucyk6XG5RLlByb21pc2U8aHR0cC5Mb2dpblJlc3BvbnNlPiB7XG4gIHRyeSB7XG4gICAgbGV0IHZhbHVlID0gbG9jYWxTdG9yYWdlKCkuZ2V0SXRlbShjb21wdXRlTG9jYWxTdG9yYWdlS2V5KHNlcnZlck9wdGlvbnMpKTtcbiAgICBpZiAoIXZhbHVlKSB7XG4gICAgICByZXR1cm4gUS5yZXNvbHZlPGh0dHAuTG9naW5SZXNwb25zZT4odW5kZWZpbmVkKTtcbiAgICB9XG4gICAgcmV0dXJuIGNpcGhlci5kZWNyeXB0SnNvbjxodHRwLkxvZ2luUmVzcG9uc2U+KGNyZWRlbnRpYWxzWydwYXNzd29yZCddLCBKU09OLnBhcnNlKHZhbHVlKSk7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgcmV0dXJuIFEucmVqZWN0PGh0dHAuTG9naW5SZXNwb25zZT4oZXJyb3IpO1xuICB9XG59XG5cbmV4cG9ydCBjb25zdCBlbXB0eUludGVybmFsID0gKCkgPT4ge1xuICByZXR1cm4gJ2hlbGxvJztcbn1cbiJdfQ==