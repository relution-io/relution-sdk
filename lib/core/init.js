/*
 * @file core/init.ts
 * Relution SDK
 *
 * Created by Thomas Beckmann on 28.04.2016
 * Copyright 2016 M-Way Solutions GmbH
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/**
 * @module core
 */
/** */
"use strict";
var _ = require('lodash');
var Q = require('q');
var url = require('url');
var diag = require('./diag');
var device = require('./device');
// workaround Q promises being inherently incompatible with zone.js used by angular2
Q.nextTick = (function detectNextTick() {
    // requires use of Q's nextTick(cb)
    Q.stopUnhandledRejectionTracking();
    // Q's nextTick(cb) is not compatible with thread-locals,
    // returned function must not be bound as zone.js reassigns global variables
    if (process && !('browser' in process) && process.nextTick) {
        return function (cb) { return process.nextTick(cb); };
    }
    else if (typeof 'setImmediate' === 'function') {
        return function (cb) { return setImmediate(cb); };
    }
    else {
        return function (cb) { return setTimeout(cb, 0); };
    }
})();
// initialize to go in sync with init() call
Q.longStackSupport = diag.debug.enabled;
/**
 * creates a deeply independent copy of some [[ServerInitOptions]].
 *
 * @param serverInitOptions to clone.
 * @return {ServerInitOptions} cloned object.
 */
function cloneServerInitOptions(serverInitOptions) {
    var result = {
        serverUrl: serverInitOptions.serverUrl,
        application: serverInitOptions.application,
        clientApp: serverInitOptions.clientApp,
        tenantOrga: serverInitOptions.tenantOrga,
        logonCallback: serverInitOptions.logonCallback,
    };
    if (result.serverUrl && result.serverUrl[result.serverUrl.length - 1] !== '/') {
        result.serverUrl += '/';
    }
    if (serverInitOptions.clientCertificate) {
        result.clientCertificate = _.clone(serverInitOptions.clientCertificate);
    }
    if (serverInitOptions.agentOptions) {
        result.agentOptions = _.clone(serverInitOptions.agentOptions);
    }
    return result;
}
exports.cloneServerInitOptions = cloneServerInitOptions;
/**
 * copy of options the SDK was initialized with using [[init]] function serving as defaults.
 *
 * @internal for SDK internal use only!
 */
exports.initOptions = {};
/**
 * (re)initializes the SDK providing global configuration parameters.
 *
 * @param options of configuration, often these are hardcoded values of the mobile client app.
 * @return promise resolving to Information object as soon as the device is ready.
 */
function init(options) {
    if (options === void 0) { options = {}; }
    if ('debug' in options) {
        diag.debug.enabled = options.debug;
        Q.longStackSupport = options.debug;
    }
    if ('serverUrl' in options) {
        var myURL = url.parse(options.serverUrl);
        if (!myURL.protocol && !myURL.host) {
            return Q.reject(new Error(options.serverUrl + " is not an accepted Url, please add a Host and a Protocol."));
        }
    }
    _.assignWith(exports.initOptions, cloneServerInitOptions(options), function (left, right) { return _.isUndefined(right) ? left : right; });
    if ('push' in options) {
        exports.initOptions.push = _.cloneDeep(options.push);
    }
    return device.ready;
}
exports.init = init;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5pdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jb3JlL2luaXQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7Ozs7Ozs7Ozs7Ozs7OztHQWtCRztBQUNIOztHQUVHO0FBQ0gsTUFBTTs7QUFHTixJQUFZLENBQUMsV0FBTSxRQUFRLENBQUMsQ0FBQTtBQUM1QixJQUFZLENBQUMsV0FBTSxHQUFHLENBQUMsQ0FBQTtBQUN2QixJQUFZLEdBQUcsV0FBTSxLQUFLLENBQUMsQ0FBQTtBQUMzQixJQUFZLElBQUksV0FBTSxRQUFRLENBQUMsQ0FBQTtBQUMvQixJQUFZLE1BQU0sV0FBTSxVQUFVLENBQUMsQ0FBQTtBQUVuQyxvRkFBb0Y7QUFDOUUsQ0FBRSxDQUFDLFFBQVEsR0FBRyxDQUFDO0lBQ25CLG1DQUFtQztJQUM3QixDQUFFLENBQUMsOEJBQThCLEVBQUUsQ0FBQztJQUMxQyx5REFBeUQ7SUFDekQsNEVBQTRFO0lBQzVFLEVBQUUsQ0FBQyxDQUFDLE9BQU8sSUFBSSxDQUFDLENBQUMsU0FBUyxJQUFJLE9BQU8sQ0FBQyxJQUFJLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO1FBQzNELE1BQU0sQ0FBQyxVQUFDLEVBQUUsSUFBSyxPQUFBLE9BQU8sQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDLEVBQXBCLENBQW9CLENBQUM7SUFDdEMsQ0FBQztJQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxPQUFPLGNBQWMsS0FBSyxVQUFVLENBQUMsQ0FBQyxDQUFDO1FBQ2hELE1BQU0sQ0FBQyxVQUFDLEVBQUUsSUFBSyxPQUFBLFlBQVksQ0FBQyxFQUFFLENBQUMsRUFBaEIsQ0FBZ0IsQ0FBQztJQUNsQyxDQUFDO0lBQUMsSUFBSSxDQUFDLENBQUM7UUFDTixNQUFNLENBQUMsVUFBQyxFQUFFLElBQUssT0FBQSxVQUFVLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxFQUFqQixDQUFpQixDQUFDO0lBQ25DLENB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OlsiLypcbiAqIEBmaWxlIGNvcmUvaW5pdC50c1xuICogUmVsdXRpb24gU0RLXG4gKlxuICogQ3JlYXRlZCBieSBUaG9tYXMgQmVja21hbm4gb24gMjguMDQuMjAxNlxuICogQ29weXJpZ2h0IDIwMTYgTS1XYXkgU29sdXRpb25zIEdtYkhcbiAqXG4gKiBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xuICogeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuICogWW91IG1heSBvYnRhaW4gYSBjb3B5IG9mIHRoZSBMaWNlbnNlIGF0XG4gKlxuICogaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogVW5sZXNzIHJlcXVpcmVkIGJ5IGFwcGxpY2FibGUgbGF3IG9yIGFncmVlZCB0byBpbiB3cml0aW5nLCBzb2Z0d2FyZVxuICogZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuICogV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG4gKiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnMgYW5kXG4gKiBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuLyoqXG4gKiBAbW9kdWxlIGNvcmVcbiAqL1xuLyoqICovXG5cbmltcG9ydCAqIGFzIHRscyBmcm9tICd0bHMnO1xuaW1wb3J0ICogYXMgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0ICogYXMgUSBmcm9tICdxJztcbmltcG9ydCAqIGFzIHVybCBmcm9tICd1cmwnO1xuaW1wb3J0ICogYXMgZGlhZyBmcm9tICcuL2RpYWcnO1xuaW1wb3J0ICogYXMgZGV2aWNlIGZyb20gJy4vZGV2aWNlJztcblxuLy8gd29ya2Fyb3VuZCBRIHByb21pc2VzIGJlaW5nIGluaGVyZW50bHkgaW5jb21wYXRpYmxlIHdpdGggem9uZS5qcyB1c2VkIGJ5IGFuZ3VsYXIyXG4oPGFueT5RKS5uZXh0VGljayA9IChmdW5jdGlvbiBkZXRlY3ROZXh0VGljaygpOiB0eXBlb2YgUS5uZXh0VGljayB7XG4gIC8vIHJlcXVpcmVzIHVzZSBvZiBRJ3MgbmV4dFRpY2soY2IpXG4gICg8YW55PlEpLnN0b3BVbmhhbmRsZWRSZWplY3Rpb25UcmFja2luZygpO1xuICAvLyBRJ3MgbmV4dFRpY2soY2IpIGlzIG5vdCBjb21wYXRpYmxlIHdpdGggdGhyZWFkLWxvY2FscyxcbiAgLy8gcmV0dXJuZWQgZnVuY3Rpb24gbXVzdCBub3QgYmUgYm91bmQgYXMgem9uZS5qcyByZWFzc2lnbnMgZ2xvYmFsIHZhcmlhYmxlc1xuICBpZiAocHJvY2VzcyAmJiAhKCdicm93c2VyJyBpbiBwcm9jZXNzKSAmJiBwcm9jZXNzLm5leHRUaWNrKSB7XG4gICAgcmV0dXJuIChjYikgPT4gcHJvY2Vzcy5uZXh0VGljayhjYik7XG4gIH0gZWxzZSBpZiAodHlwZW9mICdzZXRJbW1lZGlhdGUnID09PSAnZnVuY3Rpb24nKSB7XG4gICAgcmV0dXJuIChjYikgPT4gc2V0SW1tZWRpYXRlKGNiKTtcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gKGNiKSA9PiBzZXRUaW1lb3V0KGNiLCAwKTtcbiAgfVxufSkoKTtcblxuLy8gaW5pdGlhbGl6ZSB0byBnbyBpbiBzeW5jIHdpdGggaW5pdCgpIGNhbGxcbig8YW55PlEpLmxvbmdTdGFja1N1cHBvcnQgPSBkaWFnLmRlYnVnLmVuYWJsZWQ7XG5cbi8qKlxuICogYXBwbGllZCBvbiBlYWNoIHN1Y2Nlc3NmdWwgYXV0aGVudGljYXRpb24gd2l0aCB0aGUgUmVsdXRpb24gc2VydmVyLlxuICpcbiAqIFRoZSBmdW5jdGlvbiBtYXkgYmUgZXhlY3V0ZWQgbXVsdGlwbGUgdGltZXMsIGZvciBleGFtcGxlIHdoZW4gdGhlIHNlc3Npb24gdGltZXMgb3V0LiBUaGUgcHVycG9zZVxuICogb2YgaXQgaXMgdG8gY2FsbCBhcHBsaWNhdGlvbi1zcGVjaWZpYyBsb2dvbnMgcGFzc2luZyBpbmZvcm1hdGlvbiBzdWNoIGFzIGNyZWRlbnRpYWxzIG9mIDNyZC10aWVyXG4gKiBiYWNrZW5kIHNlcnZlcnMuXG4gKlxuICogSXQgaXMgY2FsbGVkIG9ubHkgYXMgcGFydCBvZiBvbmxpbmUgbG9naW4uIEFueSBkYXRhIHJldHVybmVkIGlzIHN0b3JlZCBpblxuICogYExvZ2luUmVzcG9uc2UubG9nb25JbmZvc2AgYW5kIHdpbGwgYmUgbWFkZSBhdmFpbGFibGUgZXZlbiBvbiBvZmZsaW5lIGxvZ2luLlxuICovXG5leHBvcnQgaW50ZXJmYWNlIExvZ29uQ2FsbGJhY2sge1xuICAodmFsdWU6IGFueSk6IFEuUHJvbWlzZTxhbnk+IHwgYW55O1xufVxuXG4vKipcbiAqIHNwZWNpZmllcyBhZGRpdGlvbmFsIG9wdGlvbnMgZm9yIHRoZSBIVFRQIGFnZW50LCBhZHZhbmNlZCBvcGVyYXRpb24uXG4gKlxuICogSW4gcmFyZSBjYXNlcyB0aGlzIGZpZWxkIG1heSBiZSB1c2VmdWwgdG8gYWx0ZXIgYmVoYXZpb3Igb2YgdGhlIHVuZGVybHlpbmcgaHR0cCBjbGllbnQuXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgSHR0cEFnZW50T3B0aW9ucyB7XG4gIGFnZW50T3B0aW9ucz86IGFueTtcbiAgYWdlbnRDbGFzcz86IGFueTtcbn1cblxuLyoqXG4gKiBvcHRpb25zIHNlbGVjdGluZyBSZWx1dGlvbiBzZXJ2ZXIgdG8gdGFsayB0by5cbiAqL1xuZXhwb3J0IGludGVyZmFjZSBTZXJ2ZXJVcmxPcHRpb25zIHtcbiAgLyoqXG4gICAqIGFic29sdXRlIHVybCBwYXRoIG9mIChkZWZhdWx0KSBSZWx1dGlvbiBzZXJ2ZXIuXG4gICAqXG4gICAqIE5vdGljZSwgdGhlIGxpYnJhcnkgd2lsbCB3b3JrIGNvcnJlY3RseSBvbmx5IGlmIHRoZSBSZWx1dGlvbiBzZXJ2ZXIgZW5kcG9pbnRzIGFyZSBleHBvc2VkXG4gICAqIGFzIGEgKHN1Yi0pZG9tYWluLiBPcGVyYXRpb24gb2YgUmVsdXRpb24gYXQgYSBzdWJwYXRoIG9mIFVSTCBzcGFjZSBpcyBub3Qgc3VwcG9ydGVkIVxuICAgKi9cbiAgc2VydmVyVXJsPzogc3RyaW5nO1xuICAvKipcbiAgICogbmFtZSBvZiAoYmFja2VuZCkgYXBwbGljYXRpb24gYXMgc3BlY2lmaWVkIGluIHJlbHV0aW9uLmpzb24uXG4gICAqXG4gICAqIEl0IGlzIGFkdmljZWQgZm9sbG93aW5nIHRoZSBjb252ZW50aW9uIG9mIHVzaW5nIHRoaXMgbmFtZSBwcmVmaXhlZCBieSBhIHNsYXNoIGFzIHRoZVxuICAgKiBgYmFzZUFsaWFzYC4gSG93ZXZlciwgaW4gY2FzZSBhIGRpZmZlcmVudCBhbGlhcyBpcyB1c2VkLCBzZXQgdGhlIGZpZWxkIHRvIHRoZSBhbGlhc1xuICAgKiBpbmNsdWRpbmcgdGhlIHNsYXNoIGluc3RlYWQgdG8gbWFrZSB0aGUgbGlicmFyeSBjb21tdW5pY2F0ZSB0byB0aGUgY29ycmVjdCBlbmRwb2ludC5cbiAgICovXG4gIGFwcGxpY2F0aW9uPzogc3RyaW5nO1xuICAvKipcbiAgICogb3B0aW9uYWwgdGVuYW50IFtbT3JnYW5pemF0aW9uXV0gdW5pcXVlIG5hbWUuXG4gICAqXG4gICAqIEZvciBmdWxseSBtdWx0aS10ZW5hbnQgY2FwYWJsZSBiYWNrZW5kcyB0aGlzIGZpZWxkIHNlbGVjdHMgdGhlIGJhY2tlbmQgaW5zdGFuY2UgdGhlIGNsaWVudFxuICAgKiB0YWxrcyB0by4gVGhlIGZpZWxkIGRlZmF1bHRzIHRvIHVzaW5nIHRoZSBbW09yZ2FuaXphdGlvbl1dIG9mIHRoZSBsb2dvbiBbW1VzZXJdXSB3aGljaFxuICAgKiBzdWZmaWNlcyBmb3IgbW9zdCB1c2UgY2FzZXMuXG4gICAqXG4gICAqIFdoZW4gc2V0IHRvIHRoZSB1bmlxdWUgbmFtZSBvZiBhbiBbW09yZ2FuaXphdGlvbl1dLCB1c2VycyBvZiBvZiBvbmUgW1tPcmdhbml6YXRpb25dXSBtYXlcbiAgICogbG9nIGludG8gdGhlIChiYWNrZW5kKSBbW2FwcGxpY2F0aW9uXV0gaW5zdGFuY2Ugb2YgYW5vdGhlciBbW09yZ2FuaXphdGlvbl1dIHNlcnZpbmcgYXNcbiAgICogdGhlIHRlbmFudC4gTm90aWNlLCBpbiBvcmRlciB0byB1c2UgdGhpcyBmZWF0dXJlIHRoZSB0ZW5hbnQgW1tPcmdhbml6YXRpb25dXSBtdXN0IGhhdmVcbiAgICogYXQgbGVhc3QgZXhlY3V0ZSByaWdodHMgb24gdGhlIChiYWNrZW5kKSBbW2FwcGxpY2F0aW9uXV0gYW5kIHRoZSBbW1VzZXJdXSB1c2luZyBpdCBuZWVkc1xuICAgKiB0byBoYXZlIHJlYWQgcGVybWlzc2lvbiBvbiB0aGUgdGVuYW50IFtbT3JnYW5pemF0aW9uXV0gdXNlZC5cbiAgICovXG4gIHRlbmFudE9yZ2E/OiBzdHJpbmc7XG59XG5cbi8qKlxuICogb3B0aW9ucyBwYXNzZWQgdG8gW1tsb2dpbl1dIG1ldGhvZCBhcyB3ZWxsIGFzIHRvIFtbaW5pdF1dIHNlcnZpbmcgYXMgZGVmYXVsdHMgZm9yIEhUVFAgbG9naW5zLlxuICovXG5leHBvcnQgaW50ZXJmYWNlIFNlcnZlckluaXRPcHRpb25zIGV4dGVuZHMgU2VydmVyVXJsT3B0aW9ucywgSHR0cEFnZW50T3B0aW9ucyB7XG4gIC8qKlxuICAgKiAobW9iaWxlKSBjbGllbnQgYXBwIHVzaW5nIHRoZSAoYmFja2VuZCkgW1thcHBsaWNhdGlvbl1dLlxuICAgKlxuICAgKiBXaGVuIHNldCwgdGhlIHZhbHVlIG9mIHRoaXMgZmllbGQgaXMgc2VuZCB0byB0aGUgUmVsdXRpb24gc2VydmVyIGZvciBpZGVudGlmaWNhdGlvblxuICAgKiBvZiB0aGUgYXBwIHVzaW5nIGl0LiBUeXBpY2FsbHksIHRoaXMgaXMgdGhlIG5hbWUgb3IgdXVpZCBvZiB0aGUgYXBwIGluIHRoZSBhcHBzdG9yZS5cbiAgICovXG4gIGNsaWVudEFwcD86IHN0cmluZztcblxuICAvKipcbiAgICogb3B0aW9uYWwgbG9nb24gYXBwbGllZCBhZnRlciBlYWNoIGxvZ2luLlxuICAgKlxuICAgKiBUeXBpY2FsbHkgdGhlIGNhbGxiYWNrIHN1cHBsaWVkIHVzZXMgY29ubmVjdG9yLmNvbmZpZ3VyZVNlc3Npb24oKSB0byB0cmFuc2ZlciByZXF1aXJlZFxuICAgKiBjcmVkZW50aWFscyBvZiAzcmQtdGllciBiYWNrZW5kIHNlcnZlcnMgYWZ0ZXIgbG9nb24uXG4gICAqXG4gICAqIE5vdGljZSwgbG9nb24gbWF5IGJlIGNhbGxlZCBtdXRpcGxlIHRpbWVzIGFmdGVyIFtbbG9naW5dXSBhcyBkdWUgdG8gaW5hY3Rpdml0eSB0aGUgc2VydmVyXG4gICAqIHNpZGUgc2Vzc2lvbiBtYXkgYmUgbG9zdCBhbmQgbmVlZHMgdG8gYmUgcmVhY3F1aXJlZCBldmVudHVhbGx5LlxuICAgKi9cbiAgbG9nb25DYWxsYmFjaz86IExvZ29uQ2FsbGJhY2s7XG5cbiAgLyoqXG4gICAqIHdoZW4gc2V0LCB0aGlzIGlzIHVzZWQgYXMgYHBmeGAgZm9yIHRoZSByZXF1ZXN0cyB0byB0aGUgc2VydmVyLlxuICAgKi9cbiAgY2xpZW50Q2VydGlmaWNhdGU/OiB0bHMuU2VjdXJlQ29udGV4dE9wdGlvbnM7XG59XG5cbi8qKlxuICogY3JlYXRlcyBhIGRlZXBseSBpbmRlcGVuZGVudCBjb3B5IG9mIHNvbWUgW1tTZXJ2ZXJJbml0T3B0aW9uc11dLlxuICpcbiAqIEBwYXJhbSBzZXJ2ZXJJbml0T3B0aW9ucyB0byBjbG9uZS5cbiAqIEByZXR1cm4ge1NlcnZlckluaXRPcHRpb25zfSBjbG9uZWQgb2JqZWN0LlxuICovXG5leHBvcnQgZnVuY3Rpb24gY2xvbmVTZXJ2ZXJJbml0T3B0aW9ucyhzZXJ2ZXJJbml0T3B0aW9uczogU2VydmVySW5pdE9wdGlvbnMpOiBTZXJ2ZXJJbml0T3B0aW9ucyB7XG4gIGxldCByZXN1bHQ6IFNlcnZlckluaXRPcHRpb25zID0ge1xuICAgIHNlcnZlclVybDogc2VydmVySW5pdE9wdGlvbnMuc2VydmVyVXJsLFxuICAgIGFwcGxpY2F0aW9uOiBzZXJ2ZXJJbml0T3B0aW9ucy5hcHBsaWNhdGlvbixcbiAgICBjbGllbnRBcHA6IHNlcnZlckluaXRPcHRpb25zLmNsaWVudEFwcCxcbiAgICB0ZW5hbnRPcmdhOiBzZXJ2ZXJJbml0T3B0aW9ucy50ZW5hbnRPcmdhLFxuICAgIGxvZ29uQ2FsbGJhY2s6IHNlcnZlckluaXRPcHRpb25zLmxvZ29uQ2FsbGJhY2ssXG4gIH07XG4gIGlmIChyZXN1bHQuc2VydmVyVXJsICYmIHJlc3VsdC5zZXJ2ZXJVcmxbcmVzdWx0LnNlcnZlclVybC5sZW5ndGggLSAxXSAhPT0gJy8nKSB7XG4gICAgcmVzdWx0LnNlcnZlclVybCArPSAnLyc7XG4gIH1cbiAgaWYgKHNlcnZlckluaXRPcHRpb25zLmNsaWVudENlcnRpZmljYXRlKSB7XG4gICAgcmVzdWx0LmNsaWVudENlcnRpZmljYXRlID0gXy5jbG9uZShzZXJ2ZXJJbml0T3B0aW9ucy5jbGllbnRDZXJ0aWZpY2F0ZSk7XG4gIH1cbiAgaWYgKHNlcnZlckluaXRPcHRpb25zLmFnZW50T3B0aW9ucykge1xuICAgIHJlc3VsdC5hZ2VudE9wdGlvbnMgPSBfLmNsb25lKHNlcnZlckluaXRPcHRpb25zLmFnZW50T3B0aW9ucyk7XG4gIH1cbiAgcmV0dXJuIHJlc3VsdDtcbn1cblxuLyoqXG4gKiBvcHRpb25hbCBvcHRpb25zIHBhc3NlZCB0byBbW2luaXRdXS5cbiAqL1xuZXhwb3J0IGludGVyZmFjZSBJbml0T3B0aW9ucyBleHRlbmRzIFNlcnZlclVybE9wdGlvbnMsIFNlcnZlckluaXRPcHRpb25zIHtcblxuICAvKipcbiAgICogd2hlbiBzZXQsIHJlY29uZmlndXJlcyBjb25zb2xlIGRlYnVnZ2luZyBhbmQgYXNzZXJ0aW9uIHRlc3Rpbmcgb2YgdGhlIGxpYnJhcnkuXG4gICAqXG4gICAqIERlZmF1bHQgc2V0dGluZyBvZiB0aGUgbGlicmFyeSBpcyBkZWJ1ZyBlbmFibGVkLlxuICAgKi9cbiAgZGVidWc/OiBib29sZWFuO1xuXG4gIC8qKlxuICAgKiBwdXNoIGNvbmZpZ3VyYXRpb24gb2YgdGhlIGFwcC5cbiAgICpcbiAgICogVXN1YWxseSwgYGluaXQoKWAgaXMgcGFzc2VkIHNvbWUgZGVwbG95bWVudCBhcnRpZmFjdCBzdWNoIGFzIHRoZSBlbnZpcm9ubWVudCBjb25zdGFudHMgaW4gYW5cbiAgICogaW9uaWMgYXBwLiBXaGVuIGRvaW5nIHNvLCB0aGUgcHVzaCBjb25maWd1cmF0aW9uIGNhbiBiZSBzcGVjaWZpZWQgZGlyZWN0bHkgYXMgcGFydCBvZiBpdC5cbiAgICovXG4gIHB1c2g/OiBQaG9uZWdhcFBsdWdpblB1c2guSW5pdE9wdGlvbnM7XG5cbn1cblxuLyoqXG4gKiBjb3B5IG9mIG9wdGlvbnMgdGhlIFNESyB3YXMgaW5pdGlhbGl6ZWQgd2l0aCB1c2luZyBbW2luaXRdXSBmdW5jdGlvbiBzZXJ2aW5nIGFzIGRlZmF1bHRzLlxuICpcbiAqIEBpbnRlcm5hbCBmb3IgU0RLIGludGVybmFsIHVzZSBvbmx5IVxuICovXG5leHBvcnQgbGV0IGluaXRPcHRpb25zOiBJbml0T3B0aW9ucyA9IHt9O1xuXG4vKipcbiAqIChyZSlpbml0aWFsaXplcyB0aGUgU0RLIHByb3ZpZGluZyBnbG9iYWwgY29uZmlndXJhdGlvbiBwYXJhbWV0ZXJzLlxuICpcbiAqIEBwYXJhbSBvcHRpb25zIG9mIGNvbmZpZ3VyYXRpb24sIG9mdGVuIHRoZXNlIGFyZSBoYXJkY29kZWQgdmFsdWVzIG9mIHRoZSBtb2JpbGUgY2xpZW50IGFwcC5cbiAqIEByZXR1cm4gcHJvbWlzZSByZXNvbHZpbmcgdG8gSW5mb3JtYXRpb24gb2JqZWN0IGFzIHNvb24gYXMgdGhlIGRldmljZSBpcyByZWFkeS5cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGluaXQob3B0aW9uczogSW5pdE9wdGlvbnMgPSB7fSkge1xuXG4gIGlmICgnZGVidWcnIGluIG9wdGlvbnMpIHtcbiAgICBkaWFnLmRlYnVnLmVuYWJsZWQgPSBvcHRpb25zLmRlYnVnO1xuICAgICg8YW55PlEpLmxvbmdTdGFja1N1cHBvcnQgPSBvcHRpb25zLmRlYnVnO1xuICB9XG5cbiAgaWYgKCdzZXJ2ZXJVcmwnIGluIG9wdGlvbnMpIHtcbiAgICBjb25zdCBteVVSTCA9IHVybC5wYXJzZShvcHRpb25zLnNlcnZlclVybCk7XG4gICAgaWYgKCFteVVSTC5wcm90b2NvbCAmJiAhbXlVUkwuaG9zdCkge1xuICAgICAgcmV0dXJuIFEucmVqZWN0PGRldmljZS5JbmZvcm1hdGlvbj4obmV3IEVycm9yKGAke29wdGlvbnMuc2VydmVyVXJsfSBpcyBub3QgYW4gYWNjZXB0ZWQgVXJsLCBwbGVhc2UgYWRkIGEgSG9zdCBhbmQgYSBQcm90b2NvbC5gKSk7XG4gICAgfVxuICB9XG5cbiAgXy5hc3NpZ25XaXRoKGluaXRPcHRpb25zLCBjbG9uZVNlcnZlckluaXRPcHRpb25zKG9wdGlvbnMpLFxuICAgIChsZWZ0OiBhbnksIHJpZ2h0OiBhbnkpID0+IF8uaXNVbmRlZmluZWQocmlnaHQpID8gbGVmdCA6IHJpZ2h0KTtcblxuICBpZiAoJ3B1c2gnIGluIG9wdGlvbnMpIHtcbiAgICBpbml0T3B0aW9ucy5wdXNoID0gXy5jbG9uZURlZXAob3B0aW9ucy5wdXNoKTtcbiAgfVxuXG4gIHJldHVybiBkZXZpY2UucmVhZHk7XG59XG4iXX0=